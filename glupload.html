<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GL Upload Viewer</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .actions button,
    .actions input[type="file"]::file-selector-button {
      padding: 8px 16px;
      background-color: #007acc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .actions button:hover,
    .actions input[type="file"]::file-selector-button:hover {
      background-color: #005fa3;
    }
    .actions input[type="file"] {
      color: #333;
      font-family: inherit;
    }
    #dataTable {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      display: none;
    }
    #dataTable th, #dataTable td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    #dataTable tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    #dataTable tbody tr:nth-child(odd) {
      background-color: #ffffff;
    }
    #dataTable th {
      background-color: #007acc;
      color: #fff;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="header"></div>

  <div class="container">
    <h1>General Ledger Upload</h1>
    <div class="actions">
      <button id="downloadTemplate">Download Template</button>
      <button id="downloadExample">Download Example Data</button>
      <input type="file" id="fileInput" accept=".csv">
    </div>
    <table id="dataTable">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="footer"></div>

  <script>
    // Load header and footer
    fetch('header.html').then(res => res.text()).then(data => {
      document.getElementById('header').innerHTML = data;
    });
    fetch('footer.html').then(res => res.text()).then(data => {
      document.getElementById('footer').innerHTML = data;
    });

    const headers = ['Trans Number','GL Act','Trans Desc','Source Code','Trans Amt','Trans Date','GL Post Date'];

    document.getElementById('downloadTemplate').addEventListener('click', function() {
      const csvContent = headers.join(',') + '\n';
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'GL_Template.csv');
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    document.getElementById('downloadExample').addEventListener('click', function() {
      let csvContent = headers.join(',') + '\n';
      for (let i = 1; i <= 100; i++) {
        const transNumber = i;
        const glAct = '4000' + (i % 10);
        const transDesc = 'Transaction ' + i;
        const sourceCode = 'SRC' + (i % 5 + 1);
        const transAmt = (Math.random() * 1000).toFixed(2);
        const transDate = `2025-01-${(i % 28 + 1).toString().padStart(2,'0')}`;
        const glPostDate = `2025-02-${(i % 28 + 1).toString().padStart(2,'0')}`;
        csvContent += `${transNumber},${glAct},${transDesc},${sourceCode},${transAmt},${transDate},${glPostDate}\n`;
      }

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'GL_Example_Data.csv');
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    function sortTableByColumn(table, columnIndex, asc = true) {
      const tbody = table.tBodies[0];
      const rows = Array.from(tbody.querySelectorAll('tr'));

      const sortedRows = rows.sort((a, b) => {
        const aText = a.querySelector(`td:nth-child(${columnIndex + 1})`).textContent.trim();
        const bText = b.querySelector(`td:nth-child(${columnIndex + 1})`).textContent.trim();
        return asc ? aText.localeCompare(bText, undefined, {numeric: true}) : bText.localeCompare(aText, undefined, {numeric: true});
      });

      while (tbody.firstChild) {
        tbody.removeChild(tbody.firstChild);
      }

      tbody.append(...sortedRows);
    }

    function addFilterAndSort() {
      const table = document.getElementById('dataTable');
      const thead = table.querySelector('thead');

      // Add sorting
      thead.querySelectorAll('th').forEach((th, index) => {
        let asc = true;
        th.addEventListener('click', () => {
          sortTableByColumn(table, index, asc);
          asc = !asc;
        });
      });

      // Add filter row
      const filterRow = document.createElement('tr');
      thead.querySelectorAll('th').forEach((th, index) => {
        const filterCell = document.createElement('th');
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Filter';
        input.addEventListener('input', () => {
          const filterValue = input.value.toLowerCase();
          document.querySelectorAll('#dataTable tbody tr').forEach(row => {
            const cellText = row.children[index].textContent.toLowerCase();
            row.style.display = cellText.includes(filterValue) ? '' : 'none';
          });
        });
        filterCell.appendChild(input);
        filterRow.appendChild(filterCell);
      });
      thead.appendChild(filterRow);
    }

    document.getElementById('fileInput').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const rows = text.split('\n').map(row => row.split(','));

        const table = document.getElementById('dataTable');
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');

        thead.innerHTML = '';
        tbody.innerHTML = '';

        if (rows.length > 0) {
          const headerRow = document.createElement('tr');
          rows[0].forEach(header => {
            const th = document.createElement('th');
            th.textContent = header.trim();
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);
        }

        for (let i = 1; i < rows.length; i++) {
          if(rows[i].length === 1 && rows[i][0] === '') continue; // skip empty lines
          const tr = document.createElement('tr');
          rows[i].forEach(cell => {
            const td = document.createElement('td');
            td.textContent = cell.trim();
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        }

        document.getElementById('dataTable').style.display = 'table';
        addFilterAndSort();
      };

      reader.readAsText(file);
    });
  </script>
</body>
</html>
